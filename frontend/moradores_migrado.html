<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Moradores - Sistema de Controle de Acesso</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Design System CSS -->
    <link rel="stylesheet" href="../assets/css/app.css">
    <!-- Tema Azul (FASE 2) -->
    <link rel="stylesheet" href="../assets/css/themes/theme-blue.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--color-background-tertiary); display: flex; }
        
        .sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background: linear-gradient(135deg, var(--color-primary-900) 0%, var(--color-primary-800) 100%); padding: 2rem 0; overflow-y: auto; z-index: 1000; }
        .sidebar h1 { color: #fff; font-size: 1.3rem; text-align: center; margin-bottom: 2rem; }
        .nav-menu { list-style: none; padding: 1rem; }
        .nav-item { margin-bottom: 0.5rem; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: rgba(255, 255, 255, 0.7); text-decoration: none; border-radius: 8px; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .nav-link i { margin-right: 0.75rem; width: 20px; }
        
        .main-content { margin-left: 260px; padding: 2rem; width: 100%; }
        .header { background: var(--color-background-primary); padding: 1.5rem 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: var(--shadow-sm); }
        .header h1 { color: var(--color-text-primary); font-size: 1.8rem; margin: 0; }
        
        .form-section, .table-section { background: var(--color-background-primary); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: var(--shadow-sm); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-grid-2 { grid-template-columns: 2fr 1fr; }
        .form-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--color-text-primary); }
        input, select, textarea { width: 100%; padding: 0.6rem; margin-bottom: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; background: var(--color-background-secondary); color: var(--color-text-primary); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary-600); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        
        button { background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-800)); color: #fff; padding: 0.6rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; margin-right: 0.5rem; }
        button:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-cancel { background: linear-gradient(135deg, var(--color-neutral-600), var(--color-neutral-700)); }
        .btn-edit { background: linear-gradient(135deg, var(--color-warning-600), var(--color-warning-700)); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-delete { background: linear-gradient(135deg, var(--color-error-600), var(--color-error-700)); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-toggle { background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-700)); padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.9rem; color: var(--color-text-primary); }
        th { background: var(--color-background-secondary); font-weight: 600; }
        
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: 500; }
        .alert-success { background: var(--color-success-50); color: var(--color-success-900); border: 1px solid var(--color-success-200); }
        .alert-error { background: var(--color-error-50); color: var(--color-error-900); border: 1px solid var(--color-error-200); }
        
        .loading { display: none; text-align: center; padding: 2rem; color: var(--color-text-secondary); }
        .loading.active { display: block; }
        .loading i { font-size: 2rem; margin-bottom: 1rem; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .search-box { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .search-box input { flex: 1; }
        
        .badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .badge-success { background: var(--color-success-100); color: var(--color-success-900); }
        .badge-danger { background: var(--color-error-100); color: var(--color-error-900); }
        
        /* Menu Toggle Mobile */
        .menu-toggle { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 1001; background: var(--color-primary-900); color: #fff; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; }
        
        /* Sistema de Abas */
        .tabs-container { background: var(--color-background-primary); border-radius: 12px; margin-bottom: 2rem; box-shadow: var(--shadow-sm); }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); padding: 0 1.5rem; }
        .tab { padding: 1rem 1.5rem; cursor: pointer; border: none; background: transparent; color: var(--color-text-secondary); font-weight: 600; font-size: 0.95rem; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: var(--color-primary-600); }
        .tab.active { color: var(--color-primary-600); border-bottom-color: var(--color-primary-600); }
        .tab-content { display: none; padding: 1.5rem; }
        .tab-content.active { display: block; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.active { transform: translateX(0); }
            .menu-toggle { display: block; }
            .main-content { margin-left: 0; padding: 1rem; }
            .header { padding: 1rem; }
            .header h1 { font-size: 1.3rem; }
            .form-section, .table-section { padding: 1rem; }
            th, td { padding: 0.5rem; font-size: 0.85rem; }
            .tabs { padding: 0 0.5rem; }
            .tab { padding: 0.75rem 1rem; font-size: 0.85rem; }
        }
        
        @media (max-width: 480px) {
            .form-grid { grid-template-columns: 1fr; }
            button { width: 100%; margin-bottom: 0.5rem; margin-right: 0; }
        }
    </style>
    <script src="js/session-manager-core.js"></script>
</head>
<body>
    <button class="menu-toggle" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>
    <nav class="sidebar" id="sidebar">
        <h1>Serra da Liberdade</h1>
        <ul class="nav-menu">
            <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li class="nav-item"><a href="moradores.html" class="nav-link active"><i class="fas fa-users"></i> Moradores</a></li>
            <li class="nav-item"><a href="layout-base.html?page=veiculos" class="nav-link"><i class="fas fa-car"></i> Veículos</a></li>
            <li class="nav-item"><a href="layout-base.html?page=visitantes" class="nav-link"><i class="fas fa-user-friends"></i> Visitantes</a></li>
            <li class="nav-item"><a href="layout-base.html?page=registro" class="nav-link"><i class="fas fa-clipboard-list"></i> Registro Manual</a></li>
            <li class="nav-item"><a href="layout-base.html?page=acesso" class="nav-link"><i class="fas fa-door-open"></i> Controle de Acesso</a></li>
            <li class="nav-item"><a href="layout-base.html?page=relatorios" class="nav-link"><i class="fas fa-file-alt"></i> Relatórios</a></li>
            <li class="nav-item"><a href="financeiro.html" class="nav-link"><i class="fas fa-money-bill-wave"></i> Financeiro</a></li>
            <li class="nav-item"><a href="configuracao.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a></li>
            <li class="nav-item"><a href="manutencao.html" class="nav-link"><i class="fas fa-tools"></i> Manutenção</a></li>
            <li class="nav-item"><a href="administrativa.html" class="nav-link"><i class="fas fa-briefcase"></i> Administrativo</a></li>

            <li class="nav-item" style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                <a href="#" class="nav-link" id="btn-logout" style="background: rgba(239, 68, 68, 0.1); color: #fca5a5;" >
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="header">
            <h1><i class="fas fa-users"></i> Cadastro de Moradores</h1>
        </header>

        <div id="alertBox"></div>

        <!-- Sistema de Abas -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="abrirAba('moradores')">
                    <i class="fas fa-users"></i> Moradores
                </button>
                <button class="tab" onclick="abrirAba('dependentes')">
                    <i class="fas fa-user-friends"></i> Dependentes
                </button>
            </div>
            
            <!-- ABA: MORADORES -->
            <div id="tab-moradores" class="tab-content active">
                <section class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 1.5rem;">
                    <h2 id="formTitle">Novo Morador</h2>
                    
                    <form id="moradorForm">
                        <input type="hidden" id="moradorId">
                        
                        <div class="form-grid">
                            <div>
                                <label>Nome Completo *</label>
                                <input type="text" id="nomeCompleto" required placeholder="Nome completo do morador">
                            </div>
                            <div>
                                <label>CPF *</label>
                                <input type="text" id="cpf" required placeholder="000.000.000-00" oninput="formatarInputCPF(this)">
                            </div>
                            <div>
                                <label>Unidade *</label>
                                <select id="unidade" required>
                                    <option value="">Selecione uma unidade</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div>
                                <label>Email</label>
                                <input type="email" id="email" placeholder="email@exemplo.com">
                            </div>
                            <div>
                                <label>Telefone</label>
                                <input type="tel" id="telefone" placeholder="(11) 3000-0000">
                            </div>
                            <div>
                                <label>Celular</label>
                                <input type="tel" id="celular" placeholder="(11) 99999-9999">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div style="grid-column: 1 / -1;">
                                <label>Observações</label>
                                <textarea id="observacao" placeholder="Observações adicionais" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" id="btnSalvarMorador">
                            <i class="fas fa-save"></i> Salvar Morador
                        </button>
                        <button type="button" class="btn-cancel" id="btnCancelarMorador" onclick="limparFormularioMorador()" style="display:none;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </form>
                </section>
                
                <!-- Tabela de Moradores -->
                <section class="table-section">
                    <h2>Lista de Moradores</h2>
                    
                    <div class="search-box">
                        <input type="text" id="searchMorador" placeholder="Pesquisar por nome, CPF ou unidade...">
                        <button onclick="buscarMoradores()"><i class="fas fa-search"></i> Buscar</button>
                        <button class="btn-cancel" onclick="limparBuscaMoradores()"><i class="fas fa-redo"></i> Limpar</button>
                    </div>
                    
                    <div class="loading" id="loadingMoradores">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Carregando moradores...</p>
                    </div>
                    
                    <table id="tabelaMoradores">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Unidade</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Celular</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>
            </div>

            <!-- ABA: DEPENDENTES -->
            <div id="tab-dependentes" class="tab-content">
                <section class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 1.5rem;">
                    <h2 id="formTitleDependente">Novo Dependente</h2>
                    
                    <form id="dependenteForm">
                        <input type="hidden" id="dependenteId">
                        <input type="hidden" id="moradorIdDependente">
                        
                        <div class="form-grid">
                            <div>
                                <label>Morador *</label>
                                <select id="moradorSelecionado" required onchange="selecionarMorador()">
                                    <option value="">Selecione um morador</option>
                                </select>
                            </div>
                            <div>
                                <label>Nome Completo *</label>
                                <input type="text" id="nomeCompletoDepend" required placeholder="Nome completo do dependente">
                            </div>
                            <div>
                                <label>CPF *</label>
                                <input type="text" id="cpfDepend" required placeholder="000.000.000-00" oninput="formatarInputCPF(this)">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div>
                                <label>Parentesco *</label>
                                <select id="parentesco" required>
                                    <option value="">Selecione...</option>
                                    <option value="Cônjuge">Cônjuge</option>
                                    <option value="Filho">Filho</option>
                                    <option value="Filha">Filha</option>
                                    <option value="Pai">Pai</option>
                                    <option value="Mãe">Mãe</option>
                                    <option value="Avô">Avô</option>
                                    <option value="Avó">Avó</option>
                                    <option value="Irmão">Irmão</option>
                                    <option value="Irmã">Irmã</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div>
                                <label>Data de Nascimento</label>
                                <input type="date" id="dataNascimentoDepend">
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" id="emailDepend" placeholder="email@exemplo.com">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div>
                                <label>Telefone</label>
                                <input type="tel" id="telefoneDepend" placeholder="(11) 3000-0000">
                            </div>
                            <div>
                                <label>Celular</label>
                                <input type="tel" id="celularDepend" placeholder="(11) 99999-9999">
                            </div>
                            <div>
                                <label>Observações</label>
                                <textarea id="observacaoDepend" placeholder="Observações adicionais" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" id="btnSalvarDependente">
                            <i class="fas fa-save"></i> Salvar Dependente
                        </button>
                        <button type="button" class="btn-cancel" id="btnCancelarDependente" onclick="limparFormularioDependente()" style="display:none;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </form>
                </section>
                
                <!-- Tabela de Dependentes -->
                <section class="table-section">
                    <h2>Lista de Dependentes</h2>
                    
                    <div class="search-box">
                        <input type="text" id="searchDependente" placeholder="Pesquisar por nome ou CPF...">
                        <button onclick="buscarDependentes()"><i class="fas fa-search"></i> Buscar</button>
                        <button class="btn-cancel" onclick="limparBuscaDependentes()"><i class="fas fa-redo"></i> Limpar</button>
                    </div>
                    
                    <div class="loading" id="loadingDependentes">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Carregando dependentes...</p>
                    </div>
                    
                    <table id="tabelaDependentes">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Parentesco</th>
                                <th>Morador</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>
            </div>
        </div>
    </main>

    <script>
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function abrirAba(abaNome) {
            // Ocultar todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os botões
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById('tab-' + abaNome).classList.add('active');
            
            // Marcar botão como ativo
            event.target.classList.add('active');
            
            // Carregar dados se necessário
            if (abaNome === 'moradores') {
                carregarMoradores();
            } else if (abaNome === 'dependentes') {
                carregarDependentes();
                carregarMoradoresParaSelect();
            }
        }

        // Inicializar ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            carregarMoradores();
            carregarUnidades();
            carregarMoradoresParaSelect();
            
            // Listeners de formulários
            document.getElementById('moradorForm').addEventListener('submit', salvarMorador);
            document.getElementById('dependenteForm').addEventListener('submit', salvarDependente);
        });

        // ============================================
        // FUNÇÕES DE MORADORES
        // ============================================

        function carregarMoradores() {
            const loading = document.getElementById('loadingMoradores');
            if (loading) loading.classList.add('active');
            
            fetch('../api/api_moradores.php?acao=listar', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (loading) loading.classList.remove('active');
                
                if (data.sucesso) {
                    preencherTabelaMoradores(data.dados || []);
                } else {
                    mostrarAlerta('Erro', data.mensagem, 'error');
                }
            })
            .catch(error => {
                if (loading) loading.classList.remove('active');
                console.error('Erro ao carregar moradores:', error);
                mostrarAlerta('Erro', 'Erro ao carregar moradores', 'error');
            });
        }

        function preencherTabelaMoradores(moradores) {
            const tbody = document.querySelector('#tabelaMoradores tbody');
            tbody.innerHTML = '';
            
            if (moradores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">Nenhum morador cadastrado</td></tr>';
                return;
            }
            
            moradores.forEach(morador => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${morador.id}</td>
                    <td>${morador.nome}</td>
                    <td>${morador.cpf}</td>
                    <td>${morador.unidade}</td>
                    <td>${morador.email || '-'}</td>
                    <td>${morador.telefone || '-'}</td>
                    <td>${morador.celular || '-'}</td>
                    <td><span class="badge badge-${morador.status === 'Ativo' ? 'success' : 'danger'}">${morador.status}</span></td>
                    <td>
                        <button class="btn-edit" onclick="editarMorador(${morador.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="deletarMorador(${morador.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function salvarMorador(e) {
            e.preventDefault();
            
            const moradorId = document.getElementById('moradorId').value;
            const dados = {
                nome: document.getElementById('nomeCompleto').value,
                cpf: document.getElementById('cpf').value,
                unidade: document.getElementById('unidade').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                celular: document.getElementById('celular').value,
                observacao: document.getElementById('observacao').value
            };
            
            const url = moradorId ? `../api/api_moradores.php?acao=atualizar&id=${moradorId}` : '../api/api_moradores.php?acao=criar';
            
            fetch(url, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta('Sucesso', 'Morador salvo com sucesso!', 'success');
                    limparFormularioMorador();
                    carregarMoradores();
                } else {
                    mostrarAlerta('Erro', data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao salvar morador:', error);
                mostrarAlerta('Erro', 'Erro ao salvar morador', 'error');
            });
        }

        function editarMorador(id) {
            fetch(`../api/api_moradores.php?acao=obter&id=${id}`, {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const morador = data.dados;
                    document.getElementById('moradorId').value = morador.id;
                    document.getElementById('nomeCompleto').value = morador.nome;
                    document.getElementById('cpf').value = morador.cpf;
                    document.getElementById('unidade').value = morador.unidade;
                    document.getElementById('email').value = morador.email || '';
                    document.getElementById('telefone').value = morador.telefone || '';
                    document.getElementById('celular').value = morador.celular || '';
                    document.getElementById('observacao').value = morador.observacao || '';
                    
                    document.getElementById('formTitle').textContent = 'Editar Morador';
                    document.getElementById('btnSalvarMorador').textContent = '? Atualizar Morador';
                    document.getElementById('btnCancelarMorador').style.display = 'inline-block';
                    
                    window.scrollTo(0, 0);
                }
            })
            .catch(error => console.error('Erro ao editar morador:', error));
        }

        function deletarMorador(id) {
            if (confirm('Tem certeza que deseja deletar este morador?')) {
                fetch(`../api/api_moradores.php?acao=deletar&id=${id}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.sucesso) {
                        mostrarAlerta('Sucesso', 'Morador deletado com sucesso!', 'success');
                        carregarMoradores();
                    } else {
                        mostrarAlerta('Erro', data.mensagem, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro ao deletar morador:', error);
                    mostrarAlerta('Erro', 'Erro ao deletar morador', 'error');
                });
            }
        }

        function limparFormularioMorador() {
            document.getElementById('moradorForm').reset();
            document.getElementById('moradorId').value = '';
            document.getElementById('formTitle').textContent = 'Novo Morador';
            document.getElementById('btnSalvarMorador').textContent = '? Salvar Morador';
            document.getElementById('btnCancelarMorador').style.display = 'none';
        }

        function buscarMoradores() {
            const termo = document.getElementById('searchMorador').value;
            if (!termo) {
                carregarMoradores();
                return;
            }
            
            const loading = document.getElementById('loadingMoradores');
            loading.classList.add('active');
            
            fetch(`../api/api_moradores.php?acao=buscar&termo=${encodeURIComponent(termo)}`, {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.remove('active');
                if (data.sucesso) {
                    preencherTabelaMoradores(data.dados || []);
                } else {
                    mostrarAlerta('Erro', data.mensagem, 'error');
                }
            })
            .catch(error => {
                loading.classList.remove('active');
                console.error('Erro ao buscar moradores:', error);
            });
        }

        function limparBuscaMoradores() {
            document.getElementById('searchMorador').value = '';
            carregarMoradores();
        }

        // ============================================
        // FUNÇÕES DE DEPENDENTES
        // ============================================

        function carregarDependentes() {
            const loading = document.getElementById('loadingDependentes');
            if (loading) loading.classList.add('active');
            
            fetch('../api/api_dependentes.php?acao=listar', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (loading) loading.classList.remove('active');
                
                if (data.sucesso) {
                    preencherTabelaDependentes(data.dados || []);
                } else {
                    mostrarAlerta('Erro', data.mensagem, 'error');
                }
            })
            .catch(error => {
                if (loading) loading.classList.remove('active');
                console.error('Erro ao carregar dependentes:', error);
            });
        }

        function preencherTabelaDependentes(dependentes) {
            const tbody = document.querySelector('#tabelaDependentes tbody');
            tbody.innerHTML = '';
            
            if (dependentes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">Nenhum dependente cadastrado</td></tr>';
                return;
            }
            
            dependentes.forEach(dependente => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dependente.id}</td>
                    <td>${dependente.nome}</td>
                    <td>${dependente.cpf}</td>
                    <td>${dependente.parentesco}</td>
                    <td>${dependente.morador}</td>
                    <td><span class="badge badge-${dependente.status === 'Ativo' ? 'success' : 'danger'}">${dependente.status}</span></td>
                    <td>
                        <button class="btn-edit" onclick="editarDependente(${dependente.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="deletarDependente(${dependente.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function carregarUnidades() {
            fetch('../api/api_unidades.php?acao=listar', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const select = document.getElementById('unidade');
                    data.dados.forEach(unidade => {
                        const option = document.createElement('option');
                        option.value = unidade.id;
                        option.textContent = unidade.numero;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Erro ao carregar unidades:', error));
        }

        function carregarMoradoresParaSelect() {
            fetch('../api/api_moradores.php?acao=listar', {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const select = document.getElementById('moradorSelecionado');
                    select.innerHTML = '<option value="">Selecione um morador</option>';
                    data.dados.forEach(morador => {
                        const option = document.createElement('option');
                        option.value = morador.id;
                        option.textContent = morador.nome;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Erro ao carregar moradores:', error));
        }

        function selecionarMorador() {
            const moradorId = document.getElementById('moradorSelecionado').value;
            document.getElementById('moradorIdDependente').value = moradorId;
        }

        function salvarDependente(e) {
            e.preventDefault();
            
            const dependenteId = document.getElementById('dependenteId').value;
            const dados = {
                morador_id: document.getElementById('moradorIdDependente').value,
                nome: document.getElementById('nomeCompletoDepend').value,
                cpf: document.getElementById('cpfDepend').value,
                parentesco: document.getElementById('parentesco').value,
                data_nascimento: document.getElementById('dataNascimentoDepend').value,
                email: document.getElementById('emailDepend').value,
                telefone: document.getElementById('telefoneDepend').value,
                celular: document.getElementById('celularDepend').value,
                observacao: document.getElementById('observacaoDepend').value
            };
            
            const url = dependenteId ? `../api/api_dependentes.php?acao=atualizar&id=${dependenteId}` : '../api/api_dependentes.php?acao=criar';
            
            fetch(url, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta('Sucesso', 'Dependente salvo com sucesso!', 'success');
                    limparFormularioDependente();
                    carregarDependentes();
                } else {
                    mostrarAlerta('Erro', data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao salvar dependente:', error);
                mostrarAlerta('Erro', 'Erro ao salvar dependente', 'error');
            });
        }

        function editarDependente(id) {
            fetch(`../api/api_dependentes.php?acao=obter&id=${id}`, {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const dependente = data.dados;
                    document.getElementById('dependenteId').value = dependente.id;
                    document.getElementById('moradorSelecionado').value = dependente.morador_id;
                    document.getElementById('moradorIdDependente').value = dependente.morador_id;
                    document.getElementById('nomeCompletoDepend').value = dependente.nome;
                    document.getElementById('cpfDepend').value = dependente.cpf;
                    document.getElementById('parentesco').value = dependente.parentesco;
                    document.getElementById('dataNascimentoDepend').value = dependente.data_nascimento || '';
                    document.getElementById('emailDepend').value = dependente.email || '';
                    document.getElementById('telefoneDepend').value = dependente.telefone || '';
                    document.getElementById('celularDepend').value = dependente.celular || '';
                    document.getElementById('observacaoDepend').value = dependente.observacao || '';
                    
                    document.getElementById('formTitleDependente').textContent = 'Editar Dependente';
                    document.getElementById('btnSalvarDependente').textContent = '? Atualizar Dependente';
                    document.getElementById('btnCancelarDependente').style.display = 'inline-block';
                    
                    window.scrollTo(0, 0);
                }
            })
            .catch(error => console.error('Erro ao editar dependente:', error));
        }

        function deletarDependente(id) {
            if (confirm('Tem certeza que deseja deletar este dependente?')) {
                fetch(`../api/api_dependentes.php?acao=deletar&id=${id}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.sucesso) {
                        mostrarAlerta('Sucesso', 'Dependente deletado com sucesso!', 'success');
                        carregarDependentes();
                    } else {
                        mostrarAlerta('Erro', data.mensagem, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro ao deletar dependente:', error);
                    mostrarAlerta('Erro', 'Erro ao deletar dependente', 'error');
                });
            }
        }

        function limparFormularioDependente() {
            document.getElementById('dependenteForm').reset();
            document.getElementById('dependenteId').value = '';
            document.getElementById('moradorIdDependente').value = '';
            document.getElementById('formTitleDependente').textContent = 'Novo Dependente';
            document.getElementById('btnSalvarDependente').textContent = '? Salvar Dependente';
            document.getElementById('btnCancelarDependente').style.display = 'none';
        }

        function buscarDependentes() {
            const termo = document.getElementById('searchDependente').value;
            if (!termo) {
                carregarDependentes();
                return;
            }
            
            const loading = document.getElementById('loadingDependentes');
            loading.classList.add('active');
            
            fetch(`../api/api_dependentes.php?acao=buscar&termo=${encodeURIComponent(termo)}`, {
                method: 'GET',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.remove('active');
                if (data.sucesso) {
                    preencherTabelaDependentes(data.dados || []);
                } else {
                    mostrarAlerta('Erro', data.mensagem, 'error');
                }
            })
            .catch(error => {
                loading.classList.remove('active');
                console.error('Erro ao buscar dependentes:', error);
            });
        }

        function limparBuscaDependentes() {
            document.getElementById('searchDependente').value = '';
            carregarDependentes();
        }

        // ============================================
        // FUNÇÕES UTILITÁRIAS
        // ============================================

        function formatarInputCPF(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length > 9) {
                value = value.substring(0, 3) + '.' + value.substring(3, 6) + '.' + value.substring(6, 9) + '-' + value.substring(9, 11);
            } else if (value.length > 6) {
                value = value.substring(0, 3) + '.' + value.substring(3, 6) + '.' + value.substring(6);
            } else if (value.length > 3) {
                value = value.substring(0, 3) + '.' + value.substring(3);
            }
            
            input.value = value;
        }

        function mostrarAlerta(titulo, mensagem, tipo) {
            const alertBox = document.getElementById('alertBox');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.innerHTML = `<strong>${titulo}:</strong> ${mensagem}`;
            alertBox.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function fazerLogout(event) {
            event.preventDefault();
            
            if (confirm('Deseja realmente sair do sistema?')) {
                fetch('../api/logout.php', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.sucesso) {
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    } else {
                        alert('Erro ao fazer logout: ' + data.mensagem);
                    }
                })
                .catch(error => {
                    console.error('Erro ao fazer logout:', error);
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                });
            }
        }
    </script>
    
    <!-- Proteção de Login -->
    <script src="js/auth-guard.js"></script>
    <script src="js/user-display.js"></script>
    <!-- Menu Controller (Single Source of Truth) -->
    <script src="js/menu-controller.js"></script>
    
    <!-- Legacy Bridge v2 (Compatibilidade) -->
    <script src="js/legacy-sidebar-bridge-v2.js"></script>
</body>
</html>






